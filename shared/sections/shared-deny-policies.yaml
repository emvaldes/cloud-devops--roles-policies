## -------------------------------------------------------------------------- ##
## 1 - Infrastructure

          ## -------------------------------------------------------------------
          ## Enforce MFA presence everywhere (services that donâ€™t pass the context use BoolIfExists)
          ## -------------------------------------------------------------------
          - Sid: DenyRequestsWithoutMFAFlag
            Effect: Deny
            Action: "*"
            Resource: "*"
            Condition:
              BoolIfExists:
                aws:MultiFactorAuthPresent: "false"  ## Deny if no MFA

          ## -------------------------------------------------------------------
          ## Session must carry mfa=true principal tag (enforced at SSO/assume time)
          ## -------------------------------------------------------------------
          - Sid: DenyUnlessSessionTaggedMFA
            Effect: Deny
            Action: "*"                       ## deny all requests when session missing required tag
            Resource: "*"
            Condition:
              StringNotEquals:
                aws:PrincipalTag/mfa: "true"  ## require federated/assumed session tag mfa=true

          ## -------------------------------------------------------------------
          ## MFA max age 1 hour
          ## -------------------------------------------------------------------
          - Sid: DenyIfMFAOlderThanOneHour
            Effect: Deny
            Action: "*"                       ## deny all requests when MFA is older than threshold
            Resource: "*"
            Condition:
              NumericGreaterThanIfExists:
                aws:MultiFactorAuthAge: 3600  ## max 3600s (1h) since last MFA verification

          ## -------------------------------------------------------------------
          ## PassRole only when CFN is the target service
          ## -------------------------------------------------------------------
          - Sid: DenyPassRoleUnlessCfnService
            Effect: Deny
            Action: iam:PassRole
            Resource: "*"
            Condition:
              StringNotEquals:
                iam:PassedToService: cloudformation.amazonaws.com  ## Force CFN-only PassRole

          ## -------------------------------------------------------------------
          ## Even for CFN, restrict the *role being passed* to CFN exec-role naming
          ## -------------------------------------------------------------------
          - Sid: DenyPassRoleOutsideCfnExecRoles
            Effect: Deny
            Action: iam:PassRole
            NotResource:
              - arn:aws:iam::*:role/cfn-*                          ## Allowed CFN exec roles
              - arn:aws:iam::*:role/cloudformation-*               ## Allowed CFN exec roles
              - arn:aws:iam::*:role/service-role/cfn-*             ## Allowed CFN exec roles
              - arn:aws:iam::*:role/service-role/cloudformation-*  ## Allowed CFN exec roles
            Condition:
              StringEquals:
                iam:PassedToService: cloudformation.amazonaws.com

          ## -------------------------------------------------------------------
          ## IAM admin blocked; allow only read/simulate and SLR creation (further restricted below)
          ## -------------------------------------------------------------------
          - Sid: DenyIamAllExceptReadSimulateAndSLR
            Effect: Deny
            NotAction:
              - iam:CreateServiceLinkedRole  ## allow SLR creation; further limited to network services by next guard
              - iam:Get*                     ## read-only inspection of identities, policies, and metadata
              - iam:List*                    ## list-only enumeration for discovery/audits
              - iam:SimulateCustomPolicy     ## run IAM policy simulator on custom policy documents
              - iam:SimulatePrincipalPolicy  ## simulate effective permissions for a given principal
            Resource: "*"

          ## -------------------------------------------------------------------
          ## Only permit SLR creation for network services
          ## -------------------------------------------------------------------
          - Sid: DenyCreateServiceLinkedRoleUnlessNetworkServices
            Effect: Deny
            Action: iam:CreateServiceLinkedRole         ## block SLR creation by default
            Resource: "*"
            Condition:
              StringNotEquals:                          ## allow only for specific AWS network services
                iam:AWSServiceName:
                  - elasticloadbalancing.amazonaws.com  ## ELBv2 / NLB / ALB
                  - globalaccelerator.amazonaws.com     ## AWS Global Accelerator
                  - network-firewall.amazonaws.com      ## AWS Network Firewall
                  - route53resolver.amazonaws.com       ## Route53 Resolver
                  - vpc-lattice.amazonaws.com           ## VPC Lattice

          ## -------------------------------------------------------------------
          ## KMS administration blocked (key/alias/grant/policy)
          ## -------------------------------------------------------------------
          - Sid: DenyKmsKeyAdministration
            Effect: Deny
            ## Toggle Resource/NotResource based on whether DnssecKmsKeyArns is set
            Resource: !If [ HasDnssecKmsKeys, !Ref "AWS::NoValue", "*" ]
            ## NotResource: !Ref DnssecKmsKeyArns  ## EXCEPT these DNSSEC keys
            NotResource: !If
              - HasDnssecKmsKeys
              - !Split [ ",", !Ref DnssecKmsKeyArns ]
              - !Ref "AWS::NoValue"
            Action:
              - kms:CancelKeyDeletion    ## prevent canceling scheduled key deletion once initiated
              - kms:Create*              ## prevent creation of KMS resources (keys, replicas, etc.)
              - kms:CreateAlias          ## prevent creating new key aliases
              - kms:CreateGrant          ## prevent creating grants (delegated key use)
              - kms:Delete*              ## prevent deletions of keys/aliases/grants/policies
              - kms:DeleteAlias          ## explicitly prevent alias deletions
              - kms:Disable*             ## prevent disabling keys/features (e.g., DisableKey, DisableKeyRotation)
              - kms:DisableKeyRotation   ## prevent turning off key rotation
              - kms:EnableKeyRotation    ## prevent turning on key rotation (freeze rotation state)
              - kms:PutKeyPolicy         ## prevent key policy changes (admin/policy tamper)
              - kms:RetireGrant          ## prevent grantees from retiring grants outside governance
              - kms:RevokeGrant          ## prevent administrators from revoking grants ad hoc
              - kms:ScheduleKeyDeletion  ## prevent scheduling key deletion
              - kms:TagResource          ## prevent adding tags on KMS resources
              - kms:UntagResource        ## prevent removing tags on KMS resources
              - kms:Update*              ## prevent updates to keys/aliases/grants/config
              - kms:UpdateAlias          ## explicitly prevent alias updates/retargeting

          ## -------------------------------------------------------------------
          ## Only allow Encrypt/ReEncrypt/DataKey via Secrets Manager (enforce service-bound usage)
          ## -------------------------------------------------------------------
          - Sid: DenyKmsEncryptAndDataKeyExceptSecretsManager
            Effect: Deny
            Action:
              - kms:Encrypt           ## prevent direct encryption unless invoked via Secrets Manager
              - kms:GenerateDataKey*  ## prevent data key generation outside Secrets Manager
              - kms:ReEncrypt*        ## prevent re-encryption unless through Secrets Manager
            Resource: "*"
            Condition:
              StringNotEqualsIfExists:
                kms:ViaService:
                  - secretsmanager.amazonaws.com  ## permit KMS only when invoked by Secrets Manager (encrypt/decrypt/rotation); direct principal KMS calls remain denied
                  - ssm.amazonaws.com             ## allow SSM Parameter Store encryption
                  - s3.amazonaws.com              ## allow S3-initiated KMS use for SSE-KMS (PutObject/Copy/Multipart, replication, lifecycle); still denies direct KMS calls by the principal

          ## -------------------------------------------------------------------
          ## Decrypt allowed only when invoked by approved services (logs, s3, secretsmanager, ssm)
          ## -------------------------------------------------------------------
          - Sid: DenyKmsDecryptOutsideApprovedServices
            Effect: Deny
            Action:
              - kms:Decrypt                        ## block decrypt by default
            Resource: "*"
            Condition:
              StringNotEqualsIfExists:             ## only allow when request comes from these AWS services
                kms:ViaService:
                  - logs.amazonaws.com             ## CloudWatch Logs (log group encryption/decryption)
                  - s3.amazonaws.com               ## S3 (SSE-KMS object encryption/decryption)
                  - secretsmanager.amazonaws.com   ## Secrets Manager (secret rotation/retrieval)
                  - ssm.amazonaws.com              ## Systems Manager Parameter Store (SecureString)

          ## -------------------------------------------------------------------
          ## Secrets Manager sensitive ops blocked; read/get remains via ceiling
          ## -------------------------------------------------------------------
          - Sid: DenySecretsManagerSensitiveOps
            Effect: Deny
            Action:
              - secretsmanager:CancelRotateSecret        ## prevent canceling an in-progress rotation
              - secretsmanager:Delete*                   ## prevent deletion of secrets, versions, replicas, policies
              - secretsmanager:DeleteResourcePolicy      ## prevent removal of resource-based policy
              - secretsmanager:PutResourcePolicy         ## prevent setting/updating resource-based policy (e.g., cross-account)
              - secretsmanager:RotateSecret              ## prevent manual rotation initiation
              - secretsmanager:StopReplicationToReplica  ## prevent stopping cross-region replication
            Resource: "*"

          ## -------------------------------------------------------------------
          ## ACM minimal safety (keep account-level + key export off)
          ## -------------------------------------------------------------------
          - Sid: DenyAcmAccountAndExportOnly
            Effect: Deny
            Action:
              - acm:ExportCertificate        ## prevent private key exfiltration
              - acm:PutAccountConfiguration  ## prevent account-wide ACM setting changes
            Resource: "*"

          ## -------------------------------------------------------------------
          ## CFN safety rails: no stack set deletes, no stack policy fiddling, no disabling termination protection
          ## -------------------------------------------------------------------
          - Sid: DenyCloudFormationPolicyAndDeletes
            Effect: Deny
            Action:
              - cloudformation:DeleteStackInstances         ## prevent destructive StackSet instance removals
              - cloudformation:DeleteStackSet               ## prevent deletion of entire StackSets
              - cloudformation:SetStackPolicy               ## disallow changing stack protection policies
              - cloudformation:UpdateTerminationProtection  ## prevent toggling termination protection
            Resource: "*"

## -------------------------------------------------------------------------- ##
## 2 - Utilities & Support

          ## -------------------------------------------------------------------
          ## Prevent CloudShell exfil/infil and credential injection
          ## -------------------------------------------------------------------
          - Sid: DenyCloudShellFileXferAndCredInject
            Effect: Deny
            Action:
              - cloudshell:GetFileDownloadUrls  ## Prevent file exfil
              - cloudshell:GetFileUploadUrls    ## Prevent file infil
              - cloudshell:PutCredentials       ## Prevent credential seeding
            Resource: "*"

          ## -------------------------------------------------------------------
          ## Amazon Q / Q Business administration blocked
          ## -------------------------------------------------------------------
          - Sid: DenyAmazonQAdministration
            Effect: Deny
            Action:
              - q:Associate*             ## block data source / app / user associations in Amazon Q
              - q:Create*                ## prevent creation of new Amazon Q resources
              - q:Delete*                ## prevent deletion of Amazon Q resources
              - q:Disassociate*          ## block disassociation of linked resources in Amazon Q
              - q:Put*                   ## prevent configuration/state changes
              - q:TagResource            ## prevent tag additions
              - q:UntagResource          ## prevent tag removals
              - q:Update*                ## prevent updates to Q resources/config
              - qbusiness:Associate*     ## block associations in Q Business
              - qbusiness:Create*        ## prevent creation of Q Business resources
              - qbusiness:Delete*        ## prevent deletion of Q Business resources
              - qbusiness:Disassociate*  ## block disassociations in Q Business
              - qbusiness:Put*           ## prevent configuration/state changes in Q Business
              - qbusiness:TagResource    ## prevent tag additions on Q Business resources
              - qbusiness:UntagResource  ## prevent tag removals on Q Business resources
              - qbusiness:Update*        ## prevent updates to Q Business resources/config
            Resource: "*"

          ## -------------------------------------------------------------------
          ## No org-wide RAM toggles
          ## -------------------------------------------------------------------
          - Sid: DenyOrgWideRAMSharing
            Effect: Deny
            Action:
              - ram:DisableSharingWithAwsOrganization  ## prevent disabling org-wide RAM sharing
              - ram:EnableSharingWithAwsOrganization   ## prevent enabling org-wide RAM sharing without governance
            Resource: "*"

          ## -------------------------------------------------------------------
          ## No Resource Explorer/Groups admin or bulk tagging
          ## -------------------------------------------------------------------
          - Sid: DenyResourceExplorerAndTaggingAdministration
            Effect: Deny
            Action:
              - resource-explorer-2:AssociateDefaultView     ## prevent setting/changing default Explorer view
              - resource-explorer-2:Create*                  ## block creation of Explorer views/indexes
              - resource-explorer-2:Delete*                  ## prevent deletion of Explorer views/indexes
              - resource-explorer-2:DisassociateDefaultView  ## prevent removing default Explorer view
              - resource-explorer-2:TagResource              ## prevent tag additions on Explorer resources
              - resource-explorer-2:UntagResource            ## prevent tag removals on Explorer resources
              - resource-explorer-2:Update*                  ## prevent updates to Explorer views/index configs
              - resource-groups:Create*                      ## block creation of new resource groups
              - resource-groups:Delete*                      ## prevent deletion of resource groups
              - resource-groups:Tag*                         ## prevent tag additions on groups
              - resource-groups:Untag*                       ## prevent tag removals on groups
              - resource-groups:Update*                      ## block updates/mutations to resource groups
              - tag:TagResources                             ## block bulk tag additions via Tag Editor
              - tag:UntagResources                           ## block bulk tag removals via Tag Editor
            Resource: "*"

## -------------------------------------------------------------------------- ##
## 3 - Observability & Telemetry

          ## -------------------------------------------------------------------
          ## AWS Config tamper prevention
          ## -------------------------------------------------------------------
          - Sid: DenyConfigTamper
            Effect: Deny
            Action:
              - config:Delete*                          ## prevent deletion of AWS Config resources/history (broad safety net)
              - config:DeleteConfigRule                 ## prevent removal of individual Config rules
              - config:DeleteRemediationConfigurations  ## prevent deleting remediation configs
              - config:PutConfigRule                    ## prevent creating/updating Config rules outside governance
              - config:PutConfigurationRecorder         ## prevent enabling/updating the configuration recorder
              - config:PutDeliveryChannel               ## prevent changing delivery channel (S3/KMS/SNS destinations)
              - config:PutRemediationConfigurations     ## prevent creating/updating remediation configs outside governance
              - config:StopConfigurationRecorder        ## prevent stopping the recorder (keeps inventory active)
            Resource: "*"

          ## -------------------------------------------------------------------
          ## CloudTrail tamper prevention
          ## -------------------------------------------------------------------
          - Sid: DenyCloudTrailTamper
            Effect: Deny
            Action:
              - cloudtrail:DeleteTrail        ## prevent deletion of trails
              - cloudtrail:PutEventSelectors  ## prevent altering event selectors (filtering scope)
              - cloudtrail:StopLogging        ## prevent disabling logging
              - cloudtrail:UpdateTrail        ## prevent mutating trail config (destinations/KMS/etc.)
            Resource: "*"

          ## -------------------------------------------------------------------
          ## CloudTrail Insights toggle off
          ## -------------------------------------------------------------------
          - Sid: DenyCloudTrailInsightsToggle
            Effect: Deny
            Action:
              - cloudtrail:PutInsightSelectors  ## prevent enabling/disabling Insights
            Resource: "*"

          ## -------------------------------------------------------------------
          ## CloudWatch Logs tamper prevention
          ## -------------------------------------------------------------------
          - Sid: DenyLogsTamper
            Effect: Deny
            Action:
              - logs:AssociateKmsKey        ## prevent arbitrary KMS key associations
              - logs:Delete*                ## prevent deletion of log groups/streams/exports
              - logs:DisassociateKmsKey     ## prevent removing KMS encryption
              - logs:PutResourcePolicy      ## prevent altering resource policies (cross-account exposure)
              - logs:PutRetentionPolicy     ## block retention changes (governed centrally)
              - logs:PutSubscriptionFilter  ## prevent creating cross-account/subscription exfil paths
            Resource: "*"

          ## -------------------------------------------------------------------
          ## CloudWatch metrics/alarms tamper prevention
          ## -------------------------------------------------------------------
          - Sid: DenyCloudWatchAlarmTamper
            Effect: Deny
            Action:
              - cloudwatch:DeleteAlarms         ## prevent deleting alarms
              - cloudwatch:DisableAlarmActions  ## prevent disabling alarm actions
              - cloudwatch:SetAlarmState        ## prevent forcing manual alarm state
            Resource: "*"

          ## -------------------------------------------------------------------
          ## X-Ray configuration tamper prevention
          ## -------------------------------------------------------------------
          - Sid: DenyXRayTamper
            Effect: Deny
            Action:
              - xray:Delete*  ## prevent deletion of X-Ray groups/rules/config
            Resource: "*"

          ## -------------------------------------------------------------------
          ## Keep account-level PAB enforced
          ## -------------------------------------------------------------------
          - Sid: DenyS3AccountPublicAccessBlockDelete
            Effect: Deny
            Action:
              - s3:DeleteAccountPublicAccessBlock  ## prevent removal of the account-wide S3 PAB
            Resource: "*"

          ## -------------------------------------------------------------------
          ## OAM sink admin blocked
          ## -------------------------------------------------------------------
          - Sid: DenyOamSinkAdministration
            Effect: Deny
            Action:
              - oam:CreateSink     ## prevent creating cross-account telemetry sinks
              - oam:DeleteSink     ## prevent deleting sinks and breaking pipelines
              - oam:PutSinkPolicy  ## prevent modifying sink resource policies
              - oam:TagResource    ## prevent adding tags on sinks
              - oam:UntagResource  ## prevent removing tags on sinks
            Resource: "*"

## -------------------------------------------------------------------------- ##
## 4 - Systems Management

          ## -------------------------------------------------------------------
          ## SSM: keep only high-risk ops denied; permit associations, MW, Automation, Parameters
          ## -------------------------------------------------------------------
          - Sid: DenySsmHighRiskAdminOnly
            Effect: Deny
            Action:
              - ssm:DeleteComplianceItems      ## prevent manual tampering of compliance data
              - ssm:DeleteInventory            ## prevent deletion of collected inventory
              - ssm:PutInventory               ## prevent spoofing/faking inventory records
              - ssm:UpdateInstanceInformation  ## prevent manual instance info updates (agent-only)
              - ssm:UpdateServiceSetting       ## prevent account-level SSM service setting changes
            Resource: "*"

          ## -------------------------------------------------------------------
          ## Extra high-risk account-wide features off
          ## -------------------------------------------------------------------
          - Sid: DenySsmHighRiskExtrasTight
            Effect: Deny
            Action:
              - ssm:CreateActivation           ## block hybrid activation bootstrap (rogue host onboarding)
              - ssm:RegisterManagedInstance    ## block hybrid managed instance registration
              - ssm:DeregisterManagedInstance  ## block deregistration that hides assets
              - ssm:CreateResourceDataSync     ## block cross-account/region telemetry export
              - ssm:UpdateResourceDataSync     ## block changes to existing sync targets
              - ssm:DeleteResourceDataSync     ## block deletion of data sync (audit trail preservation)
              - ssm:PutComplianceItems         ## block manual injection of compliance results
            Resource: "*"

          ## -------------------------------------------------------------------
          ## Enforce tag-gating for sessions/RunCommand â€” deny if tag is MISSING
          ## -------------------------------------------------------------------
          - Sid: DenySsmRunWhenTagMissing
            Effect: Deny
            Action:
              - ssm:StartSession  ## block session start if tag is missing
              - ssm:SendCommand   ## block RunCommand if tag is missing
            Resource: "*"
            Condition:
              "Null":
                ssm:resourceTag/NetworkManaged: "true"  ## key absent -> deny

          ## -------------------------------------------------------------------
          ## Enforce tag-gating for sessions/RunCommand â€” deny if tag value != "true"
          ## -------------------------------------------------------------------
          - Sid: DenySsmRunWhenTagNotTrue
            Effect: Deny
            Action:
              - ssm:StartSession  ## block session start if tag != true
              - ssm:SendCommand   ## block RunCommand if tag != true
            Resource: "*"
            Condition:
              StringNotEquals:
                ssm:resourceTag/NetworkManaged: "true"  ## present but not "true" -> deny

          ## -------------------------------------------------------------------
          ## Disallow Automation when an assume role is supplied
          ## -------------------------------------------------------------------
          - Sid: DenySsmAutomationWithAssumeRole
            Effect: Deny
            Action:
              - ssm:StartAutomationExecution       ## block automation docs from assuming roles
            Resource: "*"
            Condition:
              "Null":
                ssm:AutomationAssumeRole: "false"  ## if field present (role supplied) -> deny

          ## -------------------------------------------------------------------
          ## Require an instance profile on every EC2 launch
          ## -------------------------------------------------------------------
          - Sid: DenyRunInstancesWithoutInstanceProfile
            Effect: Deny
            Action: ec2:RunInstances         ## block EC2 launches without an attached profile
            Resource: "*"
            Condition:
              "Null":
                ec2:InstanceProfile: "true"  ## deny when instance profile is absent

## -------------------------------------------------------------------------- ##
## 5 - Networking Services

          ## -------------------------------------------------------------------
          ## Service Quotas: prevent Direct Connect quota increases (ticketed process only)
          ## -------------------------------------------------------------------
          - Sid: DenyServiceQuotasDirectConnectIncrease
            Effect: Deny
            Action:
              - servicequotas:RequestServiceQuotaIncrease  ## block quota increase requests for Direct Connect (must go through ticketed path)
            Resource: "*"
            Condition:
              StringEquals:
                servicequotas:service: directconnect       ## scope only to Direct Connect quotas

          ## -------------------------------------------------------------------
          ## Direct Connect administration blocked
          ## -------------------------------------------------------------------
          - Sid: DenyDirectConnectAdministration
            Effect: Deny
            Action:
              - directconnect:Accept*        ## block acceptance of hosted connections/VIFs/associations
              - directconnect:Allocate*      ## block allocation of new hosted connections or VIFs
              - directconnect:Associate*     ## block associating DXGWs/VIFs outside governance
              - directconnect:Attach*        ## block attaching DX resources (LAGs/gateways/etc.)
              - directconnect:Confirm*       ## block confirmations of DX connections/VIFs
              - directconnect:Create*        ## block creation of DX resources (connections/LAGs/GWs/VIFs)
              - directconnect:Delete*        ## block deletion of DX resources (connectivity risk)
              - directconnect:Detach*        ## block detaching DX resources (LAGs/gateways/etc.)
              - directconnect:Disassociate*  ## block disassociating DXGWs/VIFs once established
              - directconnect:Update*        ## block modifying DX resource configs (BGP, VLAN, MTU, etc.)
              - directconnect:TagResource    ## block tag additions on DX resources
              - directconnect:UntagResource  ## block tag removals on DX resources
            Resource: "*"

          ## -------------------------------------------------------------------
          ## Route53 Domains (registrar) admin off (protect org domain ownership)
          ## -------------------------------------------------------------------
          - Sid: DenyRoute53DomainsRegistrarAdministration
            Effect: Deny
            Action:
              - route53domains:AssociateDelegationSignerToDomain       ## block adding DS records
              - route53domains:DeleteDomain                            ## block destructive domain deletions
              - route53domains:DisableDomainAutoRenew                  ## block disabling auto-renew
              - route53domains:DisassociateDelegationSignerFromDomain  ## block removing DS records
              - route53domains:EnableDomainAutoRenew                   ## block enabling auto-renew (governed centrally)
              - route53domains:RegisterDomain                          ## block new domain registrations
              - route53domains:TransferDomain                          ## block outbound transfers
              - route53domains:TransferDomainToAnotherAwsAccount       ## block pushing domains to other accounts
              - route53domains:UpdateDomainContact                     ## block editing registrant/owner contact details
              - route53domains:UpdateDomainContactPrivacy              ## block flipping WHOIS privacy
              - route53domains:UpdateDomainNameservers                 ## block swapping nameservers
              - route53domains:UpdateTagsForDomain                     ## block domain-level tag changes
            Resource: "*"

## -------------------------------------------------------------------------- ##
## 6 - Security & Compliance

          ## -------------------------------------------------------------------
          ## Access Analyzer lifecycle/admin blocked; read still allowed by default ceiling
          ## -------------------------------------------------------------------
          - Sid: DenyAccessAnalyzerAdministration
            Effect: Deny
            Action:
              - access-analyzer:ApplyArchiveRule   ## block suppressing findings via archive rules
              - access-analyzer:Create*            ## block creating analyzers and related resources
              - access-analyzer:CreateArchiveRule  ## block explicit creation of archive rules
              - access-analyzer:Delete*            ## block deleting analyzers and their configs
              - access-analyzer:DeleteArchiveRule  ## block explicit deletion of archive rules
              - access-analyzer:StartResourceScan  ## block ad-hoc scans (must be governed)
              - access-analyzer:TagResource        ## block adding tags to analyzers
              - access-analyzer:UntagResource      ## block removing tags from analyzers
              - access-analyzer:Update*            ## block updates to analyzers and archive rules
            Resource: "*"

          ## -------------------------------------------------------------------
          ## Prevent disabling GuardDuty (detector/admin/config)
          ## -------------------------------------------------------------------
          - Sid: DenyGuardDutyDisable
            Effect: Deny
            Action:
              - guardduty:DeleteDetector                   ## prevent deletion of GuardDuty detector
              - guardduty:DisableOrganizationAdminAccount  ## prevent disabling GuardDuty delegated org admin
              - guardduty:UpdateDetector                   ## prevent weakening GuardDuty detector config
            Resource: "*"

          ## -------------------------------------------------------------------
          ## Prevent disabling Inspector (service/admin)
          ## -------------------------------------------------------------------
          - Sid: DenyInspectorDisable
            Effect: Deny
            Action:
              - inspector2:Disable                       ## prevent disabling Amazon Inspector
              - inspector2:DisableDelegatedAdminAccount  ## prevent removing Inspector delegated admin
            Resource: "*"

          ## -------------------------------------------------------------------
          ## Prevent disabling Security Hub (service/admin)
          ## -------------------------------------------------------------------
          - Sid: DenySecurityHubDisable
            Effect: Deny
            Action:
              - securityhub:DisableOrganizationAdminAccount  ## prevent disabling Security Hub delegated org admin
              - securityhub:DisableSecurityHub               ## prevent disabling Security Hub itself
            Resource: "*"

          ## -------------------------------------------------------------------
          ## Macie disable/org admin blocked
          ## -------------------------------------------------------------------
          - Sid: DenyMacieDisableAndOrgAdmin
            Effect: Deny
            Action:
              - macie2:DisableMacie                     ## block disabling Amazon Macie in the account
              - macie2:DisableOrganizationAdminAccount  ## block removing/disabling Macie delegated org admin
            Resource: "*"

## -------------------------------------------------------------------------- ##
## 7 - Development â€” Source & Orchestration

          ## -------------------------------------------------------------------
          ## CodeCommit: prevent repo lifecycle admin; allow normal Git ops
          ## -------------------------------------------------------------------
          - Sid: DenyCodeCommitRepoLifecycleAdmin
            Effect: Deny
            Action:
              - codecommit:CreateRepository             ## block creating repos (must be via IaC/pipeline)
              - codecommit:DeleteRepository             ## block deleting repos (protect history)
              - codecommit:UpdateRepositoryName         ## block renaming repos (breaks remotes/automation)
              - codecommit:UpdateRepositoryDescription  ## block unmanaged description changes
              - codecommit:PutRepositoryTriggers        ## block adding/modifying triggers (exfil paths)
            Resource: "*"

          ## -------------------------------------------------------------------
          ## CodePipeline: prevent pipeline lifecycle/admin (definition edits via CFN only)
          ## -------------------------------------------------------------------
          - Sid: DenyCodePipelineLifecycleAdmin
            Effect: Deny
            Action:
              - codepipeline:CreatePipeline  ## block creating pipelines outside IaC
              - codepipeline:UpdatePipeline  ## block editing pipeline definitions manually
              - codepipeline:DeletePipeline  ## block deleting pipelines outside change control
            Resource: "*"

          ## -------------------------------------------------------------------
          ## CodePipeline: prevent stage transition toggles
          ## -------------------------------------------------------------------
          - Sid: DenyCodePipelineStageTransitionToggle
            Effect: Deny
            Action:
              - codepipeline:DisableStageTransition  ## block pausing stage transitions
              - codepipeline:EnableStageTransition   ## block resuming transitions outside governance
            Resource: "*"

          ## -------------------------------------------------------------------
          ## CodePipeline: prevent webhook administration
          ## -------------------------------------------------------------------
          - Sid: DenyCodePipelineWebhookAdmin
            Effect: Deny
            Action:
              - codepipeline:PutWebhook     ## block creating/updating webhooks
              - codepipeline:DeleteWebhook  ## block deleting governed webhooks
            Resource: "*"

          ## -------------------------------------------------------------------
          ## CodePipeline: prevent custom action/job worker APIs
          ## -------------------------------------------------------------------
          - Sid: DenyCodePipelineCustomActionJobs
            Effect: Deny
            Action:
              - codepipeline:CreateCustomActionType         ## block defining custom action types
              - codepipeline:DeleteCustomActionType         ## block deleting custom action types
              - codepipeline:PollForJobs                    ## block human principals polling for jobs
              - codepipeline:AcknowledgeJob                 ## block manual job acknowledgements
              - codepipeline:PutJobSuccessResult            ## block faking job success
              - codepipeline:PutJobFailureResult            ## block forcing job failure
              - codepipeline:AcknowledgeThirdPartyJob       ## block acknowledging 3rd-party jobs
              - codepipeline:GetThirdPartyJobDetails        ## block fetching details of 3rd-party jobs
              - codepipeline:PutThirdPartyJobSuccessResult  ## block faking 3rd-party job success
              - codepipeline:PutThirdPartyJobFailureResult  ## block forcing 3rd-party job failure
            Resource: "*"

## -------------------------------------------------------------------------- ##
## 8 - Development â€” Build & Deployment

          ## -------------------------------------------------------------------
          ## CodeBuild: prevent project lifecycle/admin (definitions via CFN only)
          ## -------------------------------------------------------------------
          - Sid: DenyCodeBuildProjectLifecycleAdmin
            Effect: Deny
            Action:
              - codebuild:CreateProject  ## block creating CodeBuild projects (must be via IaC)
              - codebuild:UpdateProject  ## block updating project configs manually
              - codebuild:DeleteProject  ## block deleting projects outside governance
            Resource: "*"

          ## -------------------------------------------------------------------
          ## CodeBuild: prevent webhook administration
          ## -------------------------------------------------------------------
          - Sid: DenyCodeBuildWebhookAdmin
            Effect: Deny
            Action:
              - codebuild:CreateWebhook  ## block adding SCM-trigger webhooks
              - codebuild:DeleteWebhook  ## block removing governed SCM webhooks
            Resource: "*"

          ## -------------------------------------------------------------------
          ## CodeBuild: prevent source credential/admin token operations
          ## -------------------------------------------------------------------
          - Sid: DenyCodeBuildSourceCredentialAdmin
            Effect: Deny
            Action:
              - codebuild:ImportSourceCredentials  ## block storing SCM credentials in CodeBuild
              - codebuild:DeleteSourceCredentials  ## block deleting SCM credentials covertly
              - codebuild:PersistOAuthToken        ## block persisting OAuth tokens in CodeBuild
            Resource: "*"

          ## -------------------------------------------------------------------
          ## CodeBuild: prevent resource policy administration on projects/report groups
          ## -------------------------------------------------------------------
          - Sid: DenyCodeBuildResourcePolicyAdmin
            Effect: Deny
            Action:
              - codebuild:PutResourcePolicy     ## block creating/updating cross-account policies
              - codebuild:DeleteResourcePolicy  ## block deleting existing resource policies
            Resource: "*"

          ## -------------------------------------------------------------------
          ## CodeBuild: prevent making projects public
          ## -------------------------------------------------------------------
          - Sid: DenyCodeBuildPublicProjectVisibility
            Effect: Deny
            Action:
              - codebuild:UpdateProjectVisibility ## block switching projects to PUBLIC visibility
            Resource: "*"

          ## -------------------------------------------------------------------
          ## CodeBuild Fleets: prevent fleet lifecycle/admin
          ## -------------------------------------------------------------------
          - Sid: DenyCodeBuildFleetAdmin
            Effect: Deny
            Action:
              - codebuild:CreateFleet  ## block creating compute fleets
              - codebuild:UpdateFleet  ## block changing fleet size/config manually
              - codebuild:DeleteFleet  ## block deleting fleets outside governance
            Resource: "*"

          ## -------------------------------------------------------------------
          ## CodeBuild: prevent batch build APIs (single-build ops only)
          ## -------------------------------------------------------------------
          - Sid: DenyCodeBuildBatchBuilds
            Effect: Deny
            Action:
              - codebuild:StartBuildBatch  ## block starting batch builds
              - codebuild:RetryBuildBatch  ## block retrying batches manually
              - codebuild:StopBuildBatch   ## block manually stopping batch builds
            Resource: "*"

          ## -------------------------------------------------------------------
          ## CodeBuild: prevent deletion of build records
          ## -------------------------------------------------------------------
          - Sid: DenyCodeBuildDeleteBuilds
            Effect: Deny
            Action:
              - codebuild:BatchDeleteBuilds  ## block deleting build history/logs
            Resource: "*"

          ## -------------------------------------------------------------------
          ## CodeDeploy: prevent application/deployment group/config admin (definitions via CFN only)
          ## -------------------------------------------------------------------
          - Sid: DenyCodeDeployAppGroupConfigAdmin
            Effect: Deny
            Action:
              - codedeploy:CreateApplication      ## block creating apps (must be via IaC)
              - codedeploy:UpdateApplication      ## block updating app configs manually
              - codedeploy:DeleteApplication      ## block deleting apps
              - codedeploy:CreateDeploymentGroup  ## block creating deployment groups (via IaC only)
              - codedeploy:UpdateDeploymentGroup  ## block editing group configs manually
              - codedeploy:DeleteDeploymentGroup  ## block deleting deployment groups
              - codedeploy:CreateDeploymentConfig ## block creating deployment configs manually
              - codedeploy:DeleteDeploymentConfig ## block deleting governed deployment configs
            Resource: "*"

          ## -------------------------------------------------------------------
          ## CodeDeploy: prevent GitHub token administration
          ## -------------------------------------------------------------------
          - Sid: DenyCodeDeployGitHubTokenAdmin
            Effect: Deny
            Action:
              - codedeploy:RegisterGitHubAccountToken  ## block storing/updating GitHub tokens
              - codedeploy:DeleteGitHubAccountToken    ## block deleting GitHub tokens covertly
            Resource: "*"

          ## -------------------------------------------------------------------
          ## CodeDeploy: prevent on-premises instance registration
          ## -------------------------------------------------------------------
          - Sid: DenyCodeDeployOnPremAdmin
            Effect: Deny
            Action:
              - codedeploy:RegisterOnPremisesInstance    ## block unmanaged on-prem instance registration
              - codedeploy:DeregisterOnPremisesInstance  ## block deregistration (hides assets)
            Resource: "*"

## -------------------------------------------------------------------------- ##
