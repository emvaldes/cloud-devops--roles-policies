AWSTemplateFormatVersion: "2010-09-09"
Description: "Merged IAM Managed Policy — Systems Management (deny first, then allow)"

Parameters:

  ManagedPolicyName:
    Type: String
    Default: network--systems-management
    Description: "IAM managed policy name for Systems Management"

  CustomPolicyPath:
    Type: String
    Default: "/managed/network/"
    AllowedPattern: "^/([A-Za-z0-9+=,.@_-]+/)*$"
    Description: "IAM path prefix for policies (use / to disable)"

Resources:

  SystemsManagementPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:

      ManagedPolicyName: !Ref ManagedPolicyName
      Path: !Ref CustomPolicyPath

      PolicyDocument:
        Version: "2012-10-17"
        Statement:

## -------------------------------------------------------------------------- ##
## 4 - Systems Management

          ## -------------------------------------------------------------------
          ## SSM: keep only high-risk ops denied; permit associations, MW, Automation, Parameters
          ## -------------------------------------------------------------------
          - Sid: DenySsmHighRiskAdminOnly
            Effect: Deny
            Action:
              - ssm:DeleteComplianceItems      ## prevent manual tampering of compliance data
              - ssm:DeleteInventory            ## prevent deletion of collected inventory
              - ssm:PutInventory               ## prevent spoofing/faking inventory records
              - ssm:UpdateInstanceInformation  ## prevent manual instance info updates (agent-only)
              - ssm:UpdateServiceSetting       ## prevent account-level SSM service setting changes
            Resource: "*"

          ## -------------------------------------------------------------------
          ## Extra high-risk account-wide features off
          ## -------------------------------------------------------------------
          - Sid: DenySsmHighRiskExtrasTight
            Effect: Deny
            Action:
              - ssm:CreateActivation           ## block hybrid activation bootstrap (rogue host onboarding)
              - ssm:RegisterManagedInstance    ## block hybrid managed instance registration
              - ssm:DeregisterManagedInstance  ## block deregistration that hides assets
              - ssm:CreateResourceDataSync     ## block cross-account/region telemetry export
              - ssm:UpdateResourceDataSync     ## block changes to existing sync targets
              - ssm:DeleteResourceDataSync     ## block deletion of data sync (audit trail preservation)
              - ssm:PutComplianceItems         ## block manual injection of compliance results
            Resource: "*"

          ## -------------------------------------------------------------------
          ## Enforce tag-gating for sessions/RunCommand — deny if tag is MISSING
          ## -------------------------------------------------------------------
          - Sid: DenySsmRunWhenTagMissing
            Effect: Deny
            Action:
              - ssm:StartSession  ## block session start if tag is missing
              - ssm:SendCommand   ## block RunCommand if tag is missing
            Resource: "*"
            Condition:
              "Null":
                ssm:resourceTag/NetworkManaged: "true"  ## key absent -> deny

          ## -------------------------------------------------------------------
          ## Enforce tag-gating for sessions/RunCommand — deny if tag value != "true"
          ## -------------------------------------------------------------------
          - Sid: DenySsmRunWhenTagNotTrue
            Effect: Deny
            Action:
              - ssm:StartSession  ## block session start if tag != true
              - ssm:SendCommand   ## block RunCommand if tag != true
            Resource: "*"
            Condition:
              StringNotEquals:
                ssm:resourceTag/NetworkManaged: "true"  ## present but not "true" -> deny

          ## -------------------------------------------------------------------
          ## Disallow Automation when an assume role is supplied
          ## -------------------------------------------------------------------
          - Sid: DenySsmAutomationWithAssumeRole
            Effect: Deny
            Action:
              - ssm:StartAutomationExecution       ## block automation docs from assuming roles
            Resource: "*"
            Condition:
              "Null":
                ssm:AutomationAssumeRole: "false"  ## if field present (role supplied) -> deny

          ## -------------------------------------------------------------------
          ## Require an instance profile on every EC2 launch
          ## -------------------------------------------------------------------
          - Sid: DenyRunInstancesWithoutInstanceProfile
            Effect: Deny
            Action: ec2:RunInstances         ## block EC2 launches without an attached profile
            Resource: "*"
            Condition:
              "Null":
                ec2:InstanceProfile: "true"  ## deny when instance profile is absent

## -------------------------------------------------------------------------- ##
## 4 - Systems Management

          ## -------------------------------------------------------------------
          ## SSM: sessions/RunCommand (tag-gated), docs/params, minimal Automation
          ## -------------------------------------------------------------------
          - Sid: SsmCoreOps
            Effect: Allow
            Action:
              - ssm:Describe*             ## read instance/doc/compliance info
              - ssm:List*                 ## list docs/instances/commands
              - ssm:Get*                  ## get parameters/docs/outputs
              - ssm:StartSession          ## start Session Manager session
              - ssm:ResumeSession         ## resume session
              - ssm:TerminateSession      ## end session
              - ssm:SendCommand           ## RunCommand dispatch
              - ssm:CancelCommand         ## cancel command
              - ssm:GetCommandInvocation  ## fetch command output
            Resource: "*"
            Condition:
              StringEquals:
                ssm:resourceTag/NetworkManaged: "true"  ## only our instances
              StringLikeIfExists:
                ssm:DocumentName:
                  - AWS-RunShellScript       ## allow AWS basic shell
                  - AWS-RunPowerShellScript  ## allow AWS PowerShell
                  - network-*                ## allow our runbooks

          ## -------------------------------------------------------------------
          ## SSM — Associations & Maintenance Windows: full lifecycle (create/update/delete/register/describe)
          ## -------------------------------------------------------------------
          - Sid: SsmAssocAndMW
            Effect: Allow
            Action:
              - ssm:*Association          ## State Manager associations: create/update/delete/describe/list
              - ssm:*MaintenanceWindow*   ## Maintenance Windows: create/update/delete/register target/task; describe/list
            Resource: "*"

          ## -------------------------------------------------------------------
          ## SSM — Parameter Store: manage only your namespace (/network/...)
          ## -------------------------------------------------------------------
          - Sid: SsmParametersNetworkPath
            Effect: Allow
            Action:
              - ssm:*Parameter*  ## Put/Get/Delete/Label/Describe/List parameters & versions under /network/
            Resource: arn:aws:ssm:*:*:parameter/network/*

          ## -------------------------------------------------------------------
          ## SSM — Your runbooks (Documents): authoring/admin for network-* docs
          ## -------------------------------------------------------------------
          - Sid: SsmDocsNetwork
            Effect: Allow
            Action:
              - ssm:*Document*  ## CreateDocument/UpdateDocument/UpdateDocumentDefaultVersion/DeleteDocument (and related describe/list)
            Resource: arn:aws:ssm:*:*:document/network-*

          ## -------------------------------------------------------------------
          ## SSM — Global document read: fetch/inspect any SSM document
          ## -------------------------------------------------------------------
          - Sid: SsmDocsRead
            Effect: Allow
            Action:
              - ssm:GetDocument           ## retrieve document content (any scope)
              - ssm:DescribeDocument      ## read document metadata/default version
              - ssm:ListDocuments         ## enumerate documents
              - ssm:ListDocumentVersions  ## list versions of a document
            Resource: "*"

          ## -------------------------------------------------------------------
          ## SSM — Automation: start executions only for your runbooks; caller creds only
          ## -------------------------------------------------------------------
          - Sid: SsmAutomationStartNetworkDocsOnly
            Effect: Allow
            Action:
              - ssm:StartAutomationExecution        ## kick off Automation execution for allowed docs
            Resource:
              - arn:aws:ssm:*:*:document/network-*  ## only your network-* runbooks
            Condition:
              "Null":
                ssm:AutomationAssumeRole: "true"    ## require NO AutomationAssumeRole (runs with caller context)

          ## -------------------------------------------------------------------
          ## SSM — Automation results: read back executions/steps
          ## -------------------------------------------------------------------
          - Sid: SsmAutomationReadResults
            Effect: Allow
            Action:
              - ssm:GetAutomationExecution            ## fetch a specific execution
              - ssm:DescribeAutomationExecutions      ## list executions
              - ssm:DescribeAutomationStepExecutions  ## list steps within an execution
              - ssm:ListAutomationExecutions          ## alternate listing API
            Resource: "*"

## -------------------------------------------------------------------------- ##

Outputs:

  ManagedPolicyArn:
    Description: "Systems Management managed policy's ARN"
    Value: !Ref SystemsManagementPolicy
